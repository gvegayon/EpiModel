#!/usr/bin/env Rscript

# Simple EpiModel Benchmarking Script
# Generated by: GitHub Copilot (Claude Sonnet 4)
# Date: July 16, 2025
# Purpose: Benchmarking script for EpiModel netsim performance testing

library(EpiModel)

# Set seed for reproducibility
set.seed(12345)

cat("Starting EpiModel benchmarking script...\n")
cat("Network size: 1000 nodes\n")
cat("Time steps: 30\n")
cat("Simulations: 10\n\n")

# Start timing
start_time <- Sys.time()

# 1. Initialize network with 1000 nodes
cat("1. Initializing network...\n")
nw <- network_initialize(n = 1000)

# Add a simple node attribute for heterogeneity
nw <- set_vertex_attribute(nw, "race", rbinom(1000, 1, 0.5))

# 2. Set up network formation model
cat("2. Setting up formation model...\n")
formation <- ~edges + nodematch("race")

# Target statistics: roughly 2% density (1000*999*0.02/2 â‰ˆ 10000 edges)
# Plus some homophily (about 20% of edges are same-race matches)
target.stats <- c(500, 100)

# Dissolution model with average relationship duration of 20 days
coef.diss <- dissolution_coefs(dissolution = ~offset(edges), duration = 20)

# 3. Estimate the network model
cat("3. Estimating network model...\n")
est <- netest(nw, 
              formation = formation, 
              target.stats = target.stats, 
              coef.diss = coef.diss,
              verbose = FALSE)

cat("4. Setting up epidemic parameters...\n")
# Parameters for SI model
param <- param.net(inf.prob = 0.3,    # Transmission probability per contact
                   act.rate = 0.5)    # Acts per partnership per time step

# Initial conditions: 10 infected individuals
init <- init.net(i.num = 10)

# Control settings for simulation
control <- control.net(type = "SI",           # Susceptible-Infected model
                       nsteps = 30,           # 30 time steps (days)
                       nsims = 10,            # 10 simulations
                       ncores = 1,            # Single core for consistent timing
                       resimulate.network = TRUE,  # Network changes over time
                       tergmLite = TRUE,      # Use fast simulation
                       verbose = FALSE)       # Suppress progress messages

# 5. Run the simulation
cat("5. Running netsim simulation...\n")
simulation_start <- Sys.time()

mod <- netsim(est, param, init, control)

simulation_end <- Sys.time()

# Calculate timing
total_time <- simulation_end - start_time
simulation_time <- simulation_end - simulation_start

cat("6. Simulation completed!\n\n")

# Print basic results
cat("=== BENCHMARKING RESULTS ===\n")
cat(sprintf("Total script time: %.2f seconds\n", as.numeric(total_time, units = "secs")))
cat(sprintf("Simulation time: %.2f seconds\n", as.numeric(simulation_time, units = "secs")))
cat(sprintf("Average time per simulation: %.2f seconds\n", as.numeric(simulation_time, units = "secs") / 10))
cat(sprintf("Average time per time step: %.2f seconds\n", as.numeric(simulation_time, units = "secs") / (30 * 10)))

# Print summary of results
cat("\n=== SIMULATION SUMMARY ===\n")
print(mod)

# Basic epidemic curve information
cat("\n=== FINAL EPIDEMIC STATE ===\n")
final_summary <- summary(mod, at = 30)
print(final_summary)

# Optional: Save results for further analysis
# saveRDS(mod, "benchmark_results.rds")
# cat("\nResults saved to benchmark_results.rds\n")

cat("\nBenchmarking script completed successfully!\n")
